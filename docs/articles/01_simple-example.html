<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Simple Example • bcf</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="A Simple Example">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bcf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_simple-example.html">A Simple Example</a>
    </li>
    <li>
      <a href="../articles/02_predict-example.html">Prediction using BCF</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>A Simple Example</h1>
            
      
      
      <div class="hidden name"><code>01_simple-example.Rmd</code></div>

    </div>

    
    
<p>In this vignette, we show how to use BCF to estimate treatment effects of a simulated intervention.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(bcf)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(latex2exp)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rpart)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rpart.plot)</span></code></pre></div>
<div id="simulate-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulate-data" class="anchor"></a>Simulate data</h2>
<p>First, we simulate some data for testing. This data set has an outcome variable <span class="math inline">\(y\)</span>, a treatment indicator <span class="math inline">\(z\)</span>, and three covariates <span class="math inline">\(x_1\)</span>, <span class="math inline">\(x_2\)</span> and <span class="math inline">\(x_3\)</span>. Of the covariates, two affect the outcome <span class="math inline">\(y\)</span> at both levels of treatment, while the third is an effect moderator.</p>
<p>We draw three random <span class="math inline">\(x\)</span>s for each unit and generate each unit’s expected outcome without treatment, <span class="math inline">\(\mu\)</span>, as a function of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>. Each unit’s probability of joining the intervention, <span class="math inline">\(\pi\)</span>, is also a function of <span class="math inline">\(\mu\)</span>, so that units with larger responses are more likely to participate in the intervention. We then assign units to treatment (<span class="math inline">\(z = 1\)</span>) or comparison (<span class="math inline">\(z = 0\)</span>) status as a function of <span class="math inline">\(\pi\)</span>.</p>
<p>Then we generate the true treatment effect for each unit, <span class="math inline">\(\tau\)</span>. As noted above, <span class="math inline">\(\tau\)</span> is a function of <span class="math inline">\(x_3\)</span>. The observed outcome, <span class="math inline">\(y\)</span>, is a function of <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\tau\)</span>, a random error term with variance <span class="math inline">\(\sigma^{2}\)</span>, and weights <span class="math inline">\(w\)</span> if applicable.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>p &lt;-<span class="st"> </span><span class="dv">3</span> <span class="co"># two control variables and one effect moderator</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>n &lt;-<span class="st"> </span><span class="dv">1000</span> <span class="co"># number of observations</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>n_burn &lt;-<span class="st"> </span><span class="dv">2000</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>n_sim &lt;-<span class="st"> </span><span class="dv">1000</span></span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a>x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(n<span class="op">*</span>(p<span class="dv">-1</span>)), <span class="dt">nrow=</span>n)</span>
<span id="cb2-9"><a href="#cb2-9"></a>x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(x, x[,<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(n))</span>
<span id="cb2-10"><a href="#cb2-10"></a>weights &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(n))</span>
<span id="cb2-11"><a href="#cb2-11"></a></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co"># create targeted selection, whereby a practice's likelihood of joining the intervention (pi) </span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co"># is related to their expected outcome (mu)</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>mu &lt;-<span class="st"> </span><span class="dv">-1</span><span class="op">*</span>(x[,<span class="dv">1</span>]<span class="op">&gt;</span>(x[,<span class="dv">2</span>])) <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">*</span>(x[,<span class="dv">1</span>]<span class="op">&lt;</span>(x[,<span class="dv">2</span>])) <span class="op">-</span><span class="st"> </span><span class="fl">0.1</span></span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co"># generate treatment variable</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>pi &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span>(mu)</span>
<span id="cb2-18"><a href="#cb2-18"></a>z &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(n,<span class="dv">1</span>,pi)</span>
<span id="cb2-19"><a href="#cb2-19"></a></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co"># tau is the true treatment effect. It varies across practices as a function of</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="co"># X3 and X2</span></span>
<span id="cb2-22"><a href="#cb2-22"></a>tau &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span>x[,<span class="dv">3</span>])) <span class="op">+</span><span class="st"> </span>x[,<span class="dv">2</span>]<span class="op">/</span><span class="dv">10</span></span>
<span id="cb2-23"><a href="#cb2-23"></a></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co"># generate the expected response using mu, tau and z</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>y_noiseless &lt;-<span class="st"> </span>mu <span class="op">+</span><span class="st"> </span>tau<span class="op">*</span>z</span>
<span id="cb2-26"><a href="#cb2-26"></a></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co"># set the noise level relative to the expected mean function of Y</span></span>
<span id="cb2-28"><a href="#cb2-28"></a>sigma &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(mu <span class="op">+</span><span class="st"> </span>tau<span class="op">*</span>pi))<span class="op">/</span><span class="dv">8</span></span>
<span id="cb2-29"><a href="#cb2-29"></a></span>
<span id="cb2-30"><a href="#cb2-30"></a><span class="co"># draw the response variable with additive error</span></span>
<span id="cb2-31"><a href="#cb2-31"></a>y &lt;-<span class="st"> </span>y_noiseless <span class="op">+</span><span class="st"> </span>sigma<span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(n)<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(weights)</span></code></pre></div>
</div>
<div id="fit-bcf-model" class="section level2">
<h2 class="hasAnchor">
<a href="#fit-bcf-model" class="anchor"></a>Fit BCF model</h2>
<p>In this data set we have observed <span class="math inline">\(y\)</span>, <span class="math inline">\(x\)</span>, and <span class="math inline">\(\pi\)</span> values to which we can fit our BCF model. With BCF, we can distinguish between control variables – which affect the outcome at both levels of treatment – and moderator variables – which affect the estimated treatment effect.</p>
<p>Note that we are using the <code>n_chains</code> argument to <code><a href="../reference/bcf.html">bcf()</a></code>, which allows us to run several MCMC chains in parallel and assess whether they have converged to the posterior distribution.</p>
<p>After fitting the BCF model, we can compare the <span class="math inline">\(\hat{\tau}\)</span> estimates from BCF to the true <span class="math inline">\(\tau\)</span> from the data-generating process.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>bcf_out &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bcf.html">bcf</a></span>(<span class="dt">y                =</span> y,</span>
<span id="cb3-2"><a href="#cb3-2"></a>               <span class="dt">z                =</span> z,</span>
<span id="cb3-3"><a href="#cb3-3"></a>               <span class="dt">x_control        =</span> x,</span>
<span id="cb3-4"><a href="#cb3-4"></a>               <span class="dt">x_moderate       =</span> x,</span>
<span id="cb3-5"><a href="#cb3-5"></a>               <span class="dt">pihat            =</span> pi,</span>
<span id="cb3-6"><a href="#cb3-6"></a>               <span class="dt">nburn            =</span> n_burn,</span>
<span id="cb3-7"><a href="#cb3-7"></a>               <span class="dt">nsim             =</span> n_sim,</span>
<span id="cb3-8"><a href="#cb3-8"></a>               <span class="dt">w                =</span> weights,</span>
<span id="cb3-9"><a href="#cb3-9"></a>               <span class="dt">n_chains         =</span> <span class="dv">4</span>,</span>
<span id="cb3-10"><a href="#cb3-10"></a>               <span class="dt">n_cores          =</span> <span class="dv">2</span>,</span>
<span id="cb3-11"><a href="#cb3-11"></a>               <span class="dt">random_seed      =</span> <span class="dv">1</span>,</span>
<span id="cb3-12"><a href="#cb3-12"></a>               <span class="dt">update_interval  =</span> <span class="dv">1</span>)</span></code></pre></div>
</div>
<div id="check-mcmc-diagnostics" class="section level2">
<h2 class="hasAnchor">
<a href="#check-mcmc-diagnostics" class="anchor"></a>Check MCMC diagnostics</h2>
<p>We use the <code>summary.bcf</code> function to obtain posterior summary statistics and MCMC diagnostics. We use those diagnostics to assess convergence of our run.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(bcf_out)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">#&gt; Summary statistics for each Markov Chain Monte Carlo run</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">#&gt; </span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">#&gt; Iterations = 1:1000</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">#&gt; Thinning interval = 1 </span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#&gt; Number of chains = 4 </span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#&gt; Sample size per chain = 1000 </span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">#&gt; </span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">#&gt; 1. Empirical mean and standard deviation for each variable,</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">#&gt;    plus standard error of the mean:</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co">#&gt; </span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">#&gt;              Mean       SD  Naive SE Time-series SE</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">#&gt; sigma     0.37652 0.008672 0.0001371      0.0001619</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">#&gt; tau_bar   0.47725 0.041037 0.0006488      0.0012840</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">#&gt; mu_bar   -0.08635 0.023292 0.0003683      0.0007312</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co">#&gt; yhat_bar  0.19133 0.012989 0.0002054      0.0002100</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="co">#&gt; </span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="co">#&gt; 2. Quantiles for each variable:</span></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co">#&gt; </span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="co">#&gt;             2.5%     25%     50%      75%    97.5%</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="co">#&gt; sigma     0.3597  0.3707  0.3765  0.38215  0.39366</span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="co">#&gt; tau_bar   0.3960  0.4504  0.4772  0.50520  0.55821</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="co">#&gt; mu_bar   -0.1315 -0.1023 -0.0868 -0.07065 -0.04007</span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="co">#&gt; yhat_bar  0.1664  0.1824  0.1916  0.20005  0.21679</span></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="co">#&gt; </span></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="co">#&gt; </span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="co">#&gt; ----</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="co">#&gt; Effective sample size for each parameter</span></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="co">#&gt;     sigma   tau_bar    mu_bar  yhat_bar </span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="co">#&gt; 2345.6247  878.8322  978.4205 3622.4126 </span></span>
<span id="cb4-31"><a href="#cb4-31"></a><span class="co">#&gt; </span></span>
<span id="cb4-32"><a href="#cb4-32"></a><span class="co">#&gt; ----</span></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="co">#&gt; Gelman and Rubin's convergence diagnostic for each parameter</span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="co">#&gt; Potential scale reduction factors:</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="co">#&gt; </span></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="co">#&gt;          Point est. Upper C.I.</span></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="co">#&gt; sigma             1       1.01</span></span>
<span id="cb4-38"><a href="#cb4-38"></a><span class="co">#&gt; tau_bar           1       1.01</span></span>
<span id="cb4-39"><a href="#cb4-39"></a><span class="co">#&gt; mu_bar            1       1.00</span></span>
<span id="cb4-40"><a href="#cb4-40"></a><span class="co">#&gt; yhat_bar          1       1.00</span></span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="co">#&gt; </span></span>
<span id="cb4-42"><a href="#cb4-42"></a><span class="co">#&gt; Multivariate psrf</span></span>
<span id="cb4-43"><a href="#cb4-43"></a><span class="co">#&gt; </span></span>
<span id="cb4-44"><a href="#cb4-44"></a><span class="co">#&gt; 1.01</span></span>
<span id="cb4-45"><a href="#cb4-45"></a><span class="co">#&gt; </span></span>
<span id="cb4-46"><a href="#cb4-46"></a><span class="co">#&gt; ----</span></span></code></pre></div>
<p>Since our “<span class="math inline">\(\hat{R}s\)</span>” (Gelman and Rubin’s convergence factor or Potential Scale Reduction Factor) are between 0.9 and 1.1, we are confident that our run successfully achieved convergence.</p>
</div>
<div id="explore-the-posterior" class="section level2">
<h2 class="hasAnchor">
<a href="#explore-the-posterior" class="anchor"></a>Explore the posterior</h2>
<p>Now that we’ve successfully fit our model, let’s explore the output. First, since this is a simulation, let’s compare the unit-specific treatment effect estimates <span class="math inline">\(\hat{\tau}\)</span> to the true unit-specific treatment effects <span class="math inline">\(\tau\)</span>.</p>
<div id="estimates-versus-true-treatment-effects" class="section level3">
<h3 class="hasAnchor">
<a href="#estimates-versus-true-treatment-effects" class="anchor"></a>Estimates versus true treatment effects</h3>
<p>We plot the true and estimated <span class="math inline">\(\tau\)</span> versus <span class="math inline">\(x_3\)</span>, since <span class="math inline">\(x_3\)</span> is one of our primary effect moderators (see the data creation step above).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>tau_ests &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">Mean  =</span> <span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(bcf_out<span class="op">$</span>tau),</span>
<span id="cb5-2"><a href="#cb5-2"></a>                       <span class="dt">Low95 =</span> <span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(bcf_out<span class="op">$</span>tau, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(x, <span class="fl">0.025</span>)),</span>
<span id="cb5-3"><a href="#cb5-3"></a>                       <span class="dt">Up95  =</span> <span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(bcf_out<span class="op">$</span>tau, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(x, <span class="fl">0.975</span>)))</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="kw">ggplot</span>(<span class="ot">NULL</span>, <span class="kw">aes</span>(<span class="dt">x =</span> x[,<span class="dv">3</span>])) <span class="op">+</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">y =</span> tau_ests<span class="op">$</span>Mean, <span class="dt">ymin =</span> tau_ests<span class="op">$</span>Low95, <span class="dt">ymax =</span> tau_ests<span class="op">$</span>Up95), <span class="dt">color =</span> <span class="st">"forestgreen"</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">y =</span> tau), <span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="kw">TeX</span>(<span class="st">"$x_3$"</span>)) <span class="op">+</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="st">  </span><span class="kw">ylab</span>(<span class="kw">TeX</span>(<span class="st">"$</span><span class="ch">\\</span><span class="st">hat{</span><span class="ch">\\</span><span class="st">tau}$"</span>)) <span class="op">+</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.window.html">xlim</a></span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">6</span>) <span class="op">+</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="st">  </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">3</span>, <span class="dt">xend =</span> <span class="dv">4</span>, <span class="dt">y =</span> <span class="fl">0.2</span>, <span class="dt">yend =</span> <span class="fl">0.2</span>), <span class="dt">color =</span> <span class="st">"blue"</span>, <span class="dt">alpha =</span> <span class="fl">0.9</span>) <span class="op">+</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="fl">4.5</span>, <span class="dt">y =</span> <span class="fl">0.2</span>, <span class="dt">label =</span> <span class="st">"Truth"</span>), <span class="dt">color =</span> <span class="st">"black"</span>) <span class="op">+</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="st">  </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">3</span>, <span class="dt">xend =</span> <span class="dv">4</span>, <span class="dt">y =</span> <span class="fl">0.1</span>, <span class="dt">yend =</span> <span class="fl">0.1</span>), <span class="dt">color =</span> <span class="st">"forestgreen"</span>, <span class="dt">alpha =</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="fl">5.2</span>, <span class="dt">y =</span> <span class="fl">0.1</span>, <span class="dt">label =</span> <span class="st">"Estimate (95% CI)"</span>), <span class="dt">color =</span> <span class="st">"black"</span>)</span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="co">#&gt; Warning: Removed 6 rows containing non-finite values (stat_smooth).</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co">#&gt; Warning: Removed 6 rows containing missing values (geom_pointrange).</span></span></code></pre></div>
<p><img src="01_simple-example_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>BCF recovers the true unit-specific treatment effects with a high degree of accuracy in this simple example. To quantify this, we compute coverage.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>isCovered &lt;-<span class="st"> </span><span class="cf">function</span>(i){</span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="kw"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(tau_ests<span class="op">$</span>Low95[i] <span class="op">&lt;=</span><span class="st"> </span>tau[i] <span class="op">&amp;</span><span class="st"> </span>tau[i] <span class="op">&lt;=</span><span class="st"> </span>tau_ests<span class="op">$</span>Up95[i], <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb6-3"><a href="#cb6-3"></a>}</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a>coverage &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(tau), isCovered)</span>
<span id="cb6-6"><a href="#cb6-6"></a>perCoverage &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(coverage))<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(tau)</span>
<span id="cb6-7"><a href="#cb6-7"></a>perCoverage</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>We find that our estimates have 100 percent coverage at the 95 percent level, suggesting that our uncertainty estimates are slightly conservative in this example.</p>
<p>In this example, although we do see variation in the point estimates across units, most uncertainty intervals overlap, except for points at the extremes. This overlap indicates that, although there is variation in the treatment effect across units, the difference in treatment effects is not statistically meaningful at the unit level.</p>
</div>
<div id="identifying-possible-subgroups" class="section level3">
<h3 class="hasAnchor">
<a href="#identifying-possible-subgroups" class="anchor"></a>Identifying possible subgroups</h3>
<p>The BCF model obtains more accurate treatment effect estimates than other approaches partly by allowing flexible relationships with many possible effect modifiers. These relationships are often of substantive interest; researchers want to know which covariates are associated with higher or lower impacts. However, the BCF model is difficult to interpret directly: we cannot simply look at coefficients on the effect modifiers to determine which characteristics drive the impacts. Instead, we can look for patterns in the unit-specific treatment effects, linking each unit’s treatment effect estimate to its covariates.</p>
<p>Specifically, <a href="https://arxiv.org/pdf/1706.09523.pdf">Hahn, Murray, and Carvalho</a> recommend fitting a CART model where the response variable is the estimated unit-specific treatment effect from BCF and the predictor variables are the effect modifiers used to fit the BCF model. The resulting tree identifies covariates that best distinguish units with high versus low impacts, which are strong candidate subgroup variables.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>tree &lt;-<span class="st"> </span><span class="kw">rpart</span>(<span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(bcf_out<span class="op">$</span>tau) <span class="op">~</span><span class="st"> </span>x, <span class="dt">weights =</span> weights)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">rpart.plot</span>(tree)</span></code></pre></div>
<p><img src="01_simple-example_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>Our tree identifies <span class="math inline">\(x_3\)</span> as the strongest effect modifier, which is correct, because we specified it as such in the data generation step.</p>
<p>Because the CART fit does not account for the uncertainty in the treatment effect estimates, it is possible that its tree splits do not identify characteristics that create subgroups with meaningfully different impacts. To determine whether impacts differ meaningfully based on a characteristic, we can use the posterior draws from the fitted BCF model.</p>
<p>Here we show a comparison of the average treatment effect for units in the top quartile of <span class="math inline">\(x_3\)</span> versus the average treatment effect for units in the bottom quartile of <span class="math inline">\(x_3\)</span>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>q1 &lt;-<span class="st"> </span>x[,<span class="dv">3</span>] <span class="op">&lt;</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(x[,<span class="dv">3</span>], <span class="fl">0.25</span>)</span>
<span id="cb8-2"><a href="#cb8-2"></a>q4 &lt;-<span class="st"> </span>x[,<span class="dv">3</span>] <span class="op">&gt;=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(x[,<span class="dv">3</span>], <span class="fl">0.75</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a>q1Taus &lt;-<span class="st"> </span>bcf_out<span class="op">$</span>tau[,q1]</span>
<span id="cb8-5"><a href="#cb8-5"></a>q4Taus &lt;-<span class="st"> </span>bcf_out<span class="op">$</span>tau[,q4]</span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a>wq1Taus &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(q1Taus, <span class="dv">1</span>, weighted.mean, weights[q1])</span>
<span id="cb8-8"><a href="#cb8-8"></a>wq4Taus &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(q4Taus, <span class="dv">1</span>, weighted.mean, weights[q4])</span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a>groupTaus &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">taus     =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(wq1Taus, wq4Taus),</span>
<span id="cb8-11"><a href="#cb8-11"></a>                        <span class="dt">subgroup =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"q1"</span>, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(bcf_out<span class="op">$</span>tau)), <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"q4"</span>, <span class="dv">4</span><span class="op">*</span>n_sim)))</span>
<span id="cb8-12"><a href="#cb8-12"></a></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="kw">ggplot</span>(groupTaus, <span class="kw">aes</span>(taus, <span class="dt">fill =</span> subgroup, <span class="dt">color =</span> subgroup)) <span class="op">+</span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="st">  </span><span class="kw">ylab</span>(<span class="st">"posterior density"</span>) <span class="op">+</span></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="st">"average subgroup treatment effect"</span>)</span></code></pre></div>
<p><img src="01_simple-example_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>The posterior distributions for the average treatment effect of the top- and bottom-quartile units do not overlap.</p>
<p>We would therefore conclude that <span class="math inline">\(x_3\)</span> is an important subgroup variable. We can confirm this by computing the probability that the average treatment effect for the top-quartile units (q4) is greater than the average treatment effect for the bottom-quartile units (q1).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(wq4Taus <span class="op">&gt;</span><span class="st"> </span>wq1Taus)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>We found that there is a 100 percent probability that the average treatment effect for top-quartile units (q4) is greater than that for bottom-quartile units (q1).</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#simulate-data">Simulate data</a></li>
      <li><a href="#fit-bcf-model">Fit BCF model</a></li>
      <li><a href="#check-mcmc-diagnostics">Check MCMC diagnostics</a></li>
      <li><a href="#explore-the-posterior">Explore the posterior</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jared S. Murray, P. Richard Hahn, Carlos Carvalho.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
