<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prediction using BCF • bcf</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Prediction using BCF">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bcf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_simple-example.html">A Simple Example</a>
    </li>
    <li>
      <a href="../articles/02_predict-example.html">Prediction using BCF</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Prediction using BCF</h1>
            
      
      
      <div class="hidden name"><code>02_predict-example.Rmd</code></div>

    </div>

    
    
<p>In this vignette, we show how to use the <code>bcf</code> package to fit a model and use the fitted object to predict estimates for new data.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(bcf)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(latex2exp)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span></code></pre></div>
<p>To fit the model to simulated data, we follow the same process as in the “Simple Example” vignette. For that reason, we do not show the data generation and model fitting steps here.</p>
<div id="predicting-using-bcf" class="section level2">
<h2 class="hasAnchor">
<a href="#predicting-using-bcf" class="anchor"></a>Predicting using BCF</h2>
<p>Now we generate a testing dataset with 10 new observations. We make sure to include some values of <span class="math inline">\(x\)</span> that are outside the range of the <span class="math inline">\(x\)</span>s in our training dataset, to allow us to gauge out-of-sample error.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a>n_test =<span class="st"> </span><span class="dv">10</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a>x_test &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(n_test<span class="op">*</span>(p<span class="dv">-1</span>), <span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">nrow=</span>n_test) <span class="co"># sd of 2 makes x_test more dispersed than x</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>x_test &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(x_test, x_test[,<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(n_test))</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a>mu_pred  &lt;-<span class="st"> </span><span class="dv">-1</span><span class="op">*</span>(x_test[,<span class="dv">1</span>]<span class="op">&gt;</span>(x_test[,<span class="dv">2</span>])) <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">*</span>(x_test[,<span class="dv">1</span>]<span class="op">&lt;</span>(x_test[,<span class="dv">2</span>])) <span class="op">-</span><span class="st"> </span><span class="fl">0.1</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>pi_pred &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span>(mu_pred)</span>
<span id="cb2-9"><a href="#cb2-9"></a>z_pred  &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(n_test,<span class="dv">1</span>, pi_pred)</span></code></pre></div>
<p>We now predict <span class="math inline">\(y\)</span> and <span class="math inline">\(\tau\)</span> for these new observations based on our fitted model.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>pred_out =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="dt">bcfObj=</span>bcf_out,</span>
<span id="cb3-2"><a href="#cb3-2"></a>                   <span class="dt">x_predict_control=</span>x_test,</span>
<span id="cb3-3"><a href="#cb3-3"></a>                   <span class="dt">x_predict_moderate=</span>x_test,</span>
<span id="cb3-4"><a href="#cb3-4"></a>                   <span class="dt">pi_pred=</span>pi_pred,</span>
<span id="cb3-5"><a href="#cb3-5"></a>                   <span class="dt">z_pred=</span>z_pred,</span>
<span id="cb3-6"><a href="#cb3-6"></a>                   <span class="dt">save_tree_directory =</span> <span class="st">'..'</span>)</span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">#&gt; Initializing BCF Prediction</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co">#&gt; Starting Prediction</span></span></code></pre></div>
</div>
<div id="comparison" class="section level2">
<h2 class="hasAnchor">
<a href="#comparison" class="anchor"></a>Comparison</h2>
<p>Let’s compare the results for our training and testing data. We will show the estimated treatment effects for training and test observations as a function of <span class="math inline">\(x_3\)</span>, which is an effect modifier.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>tau_ests_preds &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">x     =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(x[,<span class="dv">3</span>], x_test[,<span class="dv">3</span>]),</span>
<span id="cb4-2"><a href="#cb4-2"></a>                             <span class="dt">Mean  =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(bcf_out<span class="op">$</span>tau), </span>
<span id="cb4-3"><a href="#cb4-3"></a>                                       <span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(pred_out<span class="op">$</span>tau)),</span>
<span id="cb4-4"><a href="#cb4-4"></a>                             <span class="dt">Low95 =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(bcf_out<span class="op">$</span>tau, <span class="dv">2</span>, quantile, <span class="fl">0.025</span>), </span>
<span id="cb4-5"><a href="#cb4-5"></a>                                       <span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(pred_out<span class="op">$</span>tau, <span class="dv">2</span>, quantile, <span class="fl">0.025</span>)),</span>
<span id="cb4-6"><a href="#cb4-6"></a>                             <span class="dt">Up95  =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(bcf_out<span class="op">$</span>tau, <span class="dv">2</span>, quantile, <span class="fl">0.975</span>), </span>
<span id="cb4-7"><a href="#cb4-7"></a>                                       <span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(pred_out<span class="op">$</span>tau, <span class="dv">2</span>, quantile, <span class="fl">0.975</span>)),</span>
<span id="cb4-8"><a href="#cb4-8"></a>                             <span class="dt">group =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"training"</span>, n), <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"testing"</span>, n_test))),</span>
<span id="cb4-9"><a href="#cb4-9"></a>                             <span class="dt">agroup =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0.2</span>, n), <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">1</span>, n_test)))</span>
<span id="cb4-10"><a href="#cb4-10"></a></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="kw">ggplot</span>(tau_ests_preds, <span class="kw">aes</span>(x, Mean, <span class="dt">color =</span> group)) <span class="op">+</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> Low95, <span class="dt">ymax =</span> Up95), <span class="dt">alpha =</span> tau_ests_preds<span class="op">$</span>agroup) <span class="op">+</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="kw">TeX</span>(<span class="st">"$x_3$"</span>)) <span class="op">+</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="st">  </span><span class="kw">ylab</span>(<span class="kw">TeX</span>(<span class="st">"$</span><span class="ch">\\</span><span class="st">hat{</span><span class="ch">\\</span><span class="st">tau}$"</span>)) </span></code></pre></div>
<p><img src="02_predict-example_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>The estimates for testing observations have treatment effect estimates well within the range of the treatment effect estimates for training observations, even though the test data set contains more extreme values of <span class="math inline">\(x_3\)</span>. It is reassuring that these observations’ treatment effect estimates still fall within the expected range, suggesting that this model is not overly vulnerable to out-of-sample prediction error.</p>
</div>
<div id="adjusted-subgroup-effects" class="section level2">
<h2 class="hasAnchor">
<a href="#adjusted-subgroup-effects" class="anchor"></a>Adjusted subgroup effects</h2>
<p>We can also use <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> to compute adjusted subgroup treatment effects, in other words the effect of a given covariate averaged across the levels of all other covariates. For context, this is analogous to an estimate from a standard parametric regression in which we calculate the effect of a given covariate holding the values of all other covariates constant. These are also known as mean marginal effects.</p>
<p>For example, consider the subgroups discussed in the “Simple Example” vignette, namely the bottom and top quartiles of <span class="math inline">\(x_3\)</span>. There are two approaches we could take to estimating the difference in treatment effects between these two subgroups:</p>
<ol style="list-style-type: decimal">
<li><p>We could compare the <em>unadjusted</em> subgroup average treatment effects. These are the subgroup treatment effects we calculated in the “Simple Example.” They do not hold <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> constant. To be concrete, in our example this means that – since <span class="math inline">\(x_2\)</span> and <span class="math inline">\(x_3\)</span> happen to be positively correlated – this estimate will reflect that <span class="math inline">\(x_2\)</span> values are higher for units in the top quartile of <span class="math inline">\(x_3\)</span> than for those in the bottom quartile of <span class="math inline">\(x_3\)</span>.</p></li>
<li><p>We could compare the <em>adjusted</em> subgroup average treatment effects, or mean marginal effects, by marginalizing over <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>. This estimate will hold <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> constant while comparing treatment effects for units in the top and bottom quartiles of <span class="math inline">\(x_3\)</span>.</p></li>
</ol>
<p>Because the computational intensity of the marginal effects calculation depends on the number of unique values of <span class="math inline">\(x_3\)</span> in the sample, we focus on just the first 20 observations in the training dataset, to speed up the calculation.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># subset x, weights, and tau to the first 20 observations</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>x20       &lt;-<span class="st"> </span>x[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>,]</span>
<span id="cb5-3"><a href="#cb5-3"></a>weights20 &lt;-<span class="st"> </span>weights[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>]</span>
<span id="cb5-4"><a href="#cb5-4"></a>tau20     &lt;-<span class="st"> </span>bcf_out<span class="op">$</span>tau[, <span class="dv">1</span><span class="op">:</span><span class="dv">20</span>]</span></code></pre></div>
<div id="unadjusted-subgroup-effects" class="section level3">
<h3 class="hasAnchor">
<a href="#unadjusted-subgroup-effects" class="anchor"></a>Unadjusted subgroup effects</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># create indicators for whether units are in the bottom/top quartile of x3</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>q1 &lt;-<span class="st"> </span>x20[,<span class="dv">3</span>] <span class="op">&lt;</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(x20[,<span class="dv">3</span>], <span class="fl">0.25</span>)</span>
<span id="cb6-3"><a href="#cb6-3"></a>q4 &lt;-<span class="st"> </span>x20[,<span class="dv">3</span>] <span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(x20[,<span class="dv">3</span>], <span class="fl">0.75</span>)</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co"># subset the tau matrix to units in the bottom/top quartile of x3</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>q1Taus &lt;-<span class="st"> </span>tau20[, q1]</span>
<span id="cb6-7"><a href="#cb6-7"></a>q4Taus &lt;-<span class="st"> </span>tau20[, q4]</span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co"># roll up across units within each subgroup to calculate unadjusted subgroup average treatment effects</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co"># by taking weighted averages</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>q1avgTau &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(q1Taus, <span class="dv">1</span>, weighted.mean, weights20[q1])</span>
<span id="cb6-12"><a href="#cb6-12"></a>q4avgTau &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(q4Taus, <span class="dv">1</span>, weighted.mean, weights20[q4])</span>
<span id="cb6-13"><a href="#cb6-13"></a></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co"># calculate the posterior distribution of the difference in unadjusted subgroup average treatment effects</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>unadjustedDiff &lt;-<span class="st"> </span>q4avgTau <span class="op">-</span><span class="st"> </span>q1avgTau</span></code></pre></div>
</div>
<div id="adjusted-subgroup-effects-1" class="section level3">
<h3 class="hasAnchor">
<a href="#adjusted-subgroup-effects-1" class="anchor"></a>Adjusted subgroup effects</h3>
<p>For each unit <span class="math inline">\(j\)</span> in our dataset, for each value of <span class="math inline">\(x_3\)</span> in the bottom/top quartile, we predict the treatment effect holding the <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> fixed at unit <span class="math inline">\(j\)</span>’s observed values of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>. The difference between those two means is the difference in subgroup impacts <em>for unit</em> <span class="math inline">\(j\)</span>. After repeating this calculation for each unit in the dataset, we take a weighted average across all units in the dataset to estimate the difference in adjusted subgroup average treatment effects.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># # create placeholder values for pi and z. </span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co"># # note that the values of these placeholders don't matter, since tau doesn't depend on pi or z</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co"># piPred &lt;- rep(.5, 20/4) # each quartile has 1/4th of the total of 20 units in it</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co"># zPred  &lt;- rep_len(0:1, length.out=20/4) </span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co"># </span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co"># #create an empty object to hold the components of the mean marginal effect</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co"># adjustedDiffs &lt;- matrix(NA, nrow(bcf_out$tau), 20)</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co"># </span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co"># # for each person j in the dataset</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co"># for (j in 1:20){</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co">#   print(j)</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">#   # for each value of x3 in the bottom quartile of x3</span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="co">#   xPredQ1 &lt;- x20[q1,]</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co">#   # and for each value of x3 in the top quartile of x3</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="co">#   xPredQ4 &lt;- x20[q4,]</span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="co">#   # hold the values of x1 and x2 fixed at person j's actual values of x1 and x2</span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="co">#   xPredQ1[,1] &lt;- x20[j,1]</span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="co">#   xPredQ4[,1] &lt;- x20[j,1]</span></span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="co">#   xPredQ1[,2] &lt;- x20[j,2]</span></span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="co">#   xPredQ4[,2] &lt;- x20[j,2]</span></span>
<span id="cb7-21"><a href="#cb7-21"></a><span class="co">#   # predict the treatment effect for each simulated unit</span></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="co">#   tauPredQ1 = predict(bcfObj              = bcf_out,</span></span>
<span id="cb7-23"><a href="#cb7-23"></a><span class="co">#                      x_predict_control   = xPredQ1,</span></span>
<span id="cb7-24"><a href="#cb7-24"></a><span class="co">#                      x_predict_moderate  = xPredQ1,</span></span>
<span id="cb7-25"><a href="#cb7-25"></a><span class="co">#                      pi_pred             = piPred,</span></span>
<span id="cb7-26"><a href="#cb7-26"></a><span class="co">#                      z_pred              = zPred,</span></span>
<span id="cb7-27"><a href="#cb7-27"></a><span class="co">#                      save_tree_directory = '..')$tau </span></span>
<span id="cb7-28"><a href="#cb7-28"></a><span class="co">#   tauPredQ4 = predict(bcfObj              = bcf_out,</span></span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="co">#                      x_predict_control   = xPredQ4,</span></span>
<span id="cb7-30"><a href="#cb7-30"></a><span class="co">#                      x_predict_moderate  = xPredQ4,</span></span>
<span id="cb7-31"><a href="#cb7-31"></a><span class="co">#                      pi_pred             = piPred,</span></span>
<span id="cb7-32"><a href="#cb7-32"></a><span class="co">#                      z_pred              = zPred,</span></span>
<span id="cb7-33"><a href="#cb7-33"></a><span class="co">#                      save_tree_directory = '..')$tau </span></span>
<span id="cb7-34"><a href="#cb7-34"></a><span class="co">#   # roll up across the possible values of x3</span></span>
<span id="cb7-35"><a href="#cb7-35"></a><span class="co">#   q1avgTau &lt;- apply(tauPredQ1, 1, mean)</span></span>
<span id="cb7-36"><a href="#cb7-36"></a><span class="co">#   q4avgTau &lt;- apply(tauPredQ4, 1, mean)</span></span>
<span id="cb7-37"><a href="#cb7-37"></a><span class="co">#   # calculate person j's difference in subgroup average treatment effects</span></span>
<span id="cb7-38"><a href="#cb7-38"></a><span class="co">#   adjustedDiffs[,j] &lt;- q4avgTau - q1avgTau</span></span>
<span id="cb7-39"><a href="#cb7-39"></a><span class="co"># }</span></span>
<span id="cb7-40"><a href="#cb7-40"></a><span class="co"># # roll up across units to by taking weighted averages</span></span>
<span id="cb7-41"><a href="#cb7-41"></a><span class="co"># adjustedDiff &lt;- apply(adjustedDiffs, 1, weighted.mean, weights20)</span></span>
<span id="cb7-42"><a href="#cb7-42"></a></span>
<span id="cb7-43"><a href="#cb7-43"></a><span class="co"># the following code arrives at the same answer as the code above that is commented out.</span></span>
<span id="cb7-44"><a href="#cb7-44"></a><span class="co"># it is more opaque, but much quicker, so we've included both for reference.</span></span>
<span id="cb7-45"><a href="#cb7-45"></a>whichX1X2 &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">20</span></span>
<span id="cb7-46"><a href="#cb7-46"></a>whichX3   &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(q1 <span class="op">|</span><span class="st"> </span>q4)</span>
<span id="cb7-47"><a href="#cb7-47"></a>whichXs   &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span>(whichX1X2, whichX3)</span>
<span id="cb7-48"><a href="#cb7-48"></a>xPred  &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(x20[whichXs[,<span class="dv">1</span>], <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], x20[whichXs[,<span class="dv">2</span>], <span class="dv">3</span>])</span>
<span id="cb7-49"><a href="#cb7-49"></a>piPred &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(.<span class="dv">5</span>, <span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(xPred)) </span>
<span id="cb7-50"><a href="#cb7-50"></a>zPred  &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep_len</a></span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">length.out=</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(xPred))</span>
<span id="cb7-51"><a href="#cb7-51"></a>tauPred =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="dt">bcfObj              =</span> bcf_out,</span>
<span id="cb7-52"><a href="#cb7-52"></a>                  <span class="dt">x_predict_control   =</span> xPred,</span>
<span id="cb7-53"><a href="#cb7-53"></a>                  <span class="dt">x_predict_moderate  =</span> xPred,</span>
<span id="cb7-54"><a href="#cb7-54"></a>                  <span class="dt">pi_pred             =</span> piPred,</span>
<span id="cb7-55"><a href="#cb7-55"></a>                  <span class="dt">z_pred              =</span> zPred,</span>
<span id="cb7-56"><a href="#cb7-56"></a>                  <span class="dt">save_tree_directory =</span> <span class="st">'..'</span>)<span class="op">$</span>tau</span>
<span id="cb7-57"><a href="#cb7-57"></a><span class="co">#&gt; Initializing BCF Prediction</span></span>
<span id="cb7-58"><a href="#cb7-58"></a><span class="co">#&gt; Starting Prediction</span></span>
<span id="cb7-59"><a href="#cb7-59"></a>wPreds  &lt;-<span class="st"> </span>weights20[whichXs[,<span class="dv">1</span>]] </span>
<span id="cb7-60"><a href="#cb7-60"></a>q1Preds &lt;-<span class="st"> </span>whichXs[,<span class="dv">2</span>] <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(q1)</span>
<span id="cb7-61"><a href="#cb7-61"></a>q4Preds &lt;-<span class="st"> </span>whichXs[,<span class="dv">2</span>] <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(q4)</span>
<span id="cb7-62"><a href="#cb7-62"></a>q1avgTau &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(tauPred[,q1Preds], <span class="dv">1</span>, weighted.mean, wPreds[q1Preds])</span>
<span id="cb7-63"><a href="#cb7-63"></a>q4avgTau &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(tauPred[,q4Preds], <span class="dv">1</span>, weighted.mean, wPreds[q4Preds])</span>
<span id="cb7-64"><a href="#cb7-64"></a>adjustedDiff &lt;-<span class="st"> </span>q4avgTau <span class="op">-</span><span class="st"> </span>q1avgTau</span></code></pre></div>
</div>
<div id="comparison-1" class="section level3">
<h3 class="hasAnchor">
<a href="#comparison-1" class="anchor"></a>Comparison</h3>
<p>We compare the posterior distributions of the unadjusted and adjusted estimates of the difference in subgroups average treatment effects.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>diffDF &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">diffs  =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(unadjustedDiff, adjustedDiff),</span>
<span id="cb8-2"><a href="#cb8-2"></a>                     <span class="dt">Group =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"Unadjusted"</span>, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(unadjustedDiff)), </span>
<span id="cb8-3"><a href="#cb8-3"></a>                               <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"Adjusted"</span>, <span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(adjustedDiff))))</span>
<span id="cb8-4"><a href="#cb8-4"></a>  </span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw">ggplot</span>(diffDF, <span class="kw">aes</span>(diffs, <span class="dt">group =</span> Group, <span class="dt">color =</span> Group, <span class="dt">fill =</span> Group)) <span class="op">+</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">geom_density</span>(<span class="dt">alpha =</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="kw">xlab</span>(<span class="kw">TeX</span>(<span class="st">"Difference in subgroup average treatment effects"</span>))</span></code></pre></div>
<p><img src="02_predict-example_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>The two approaches (adjusted and unadjusted) produce slightly different results in estimating the difference in impacts between the first and fourth quartiles of <span class="math inline">\(x_3\)</span>: the adjusted difference is smaller, though not by a statistically meaningful amount. Nevertheless, the figure above implies that part of what we called a difference in impacts between the top and bottom quartiles in the “Simple Example” vignette was a difference in the distributions of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> between those two quartiles.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#predicting-using-bcf">Predicting using BCF</a></li>
      <li><a href="#comparison">Comparison</a></li>
      <li><a href="#adjusted-subgroup-effects">Adjusted subgroup effects</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jared S. Murray, P. Richard Hahn, Carlos Carvalho.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
